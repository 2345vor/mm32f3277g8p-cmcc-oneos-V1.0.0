# 1. ä»‹ç»ğŸ
TB6612FNGæ˜¯ä¸€ç§ç®€å•ä¸”ç»æµå®æƒ çš„ç”µæœºæ§åˆ¶æ–¹å¼ã€‚TB6612FNG èƒ½å¤Ÿä»¥é«˜è¾¾ 1.2A çš„æ’å®šç”µæµé©±åŠ¨ä¸¤ä¸ªç”µæœºã€‚åœ¨ IC å†…éƒ¨ï¼Œæ‚¨ä¼šåœ¨ä¸€ä¸ªèŠ¯ç‰‡ä¸Šæ‰¾åˆ°ä¸¤ä¸ªæ ‡å‡† H æ¡¥ï¼Œè®©æ‚¨ä¸ä»…å¯ä»¥æ§åˆ¶ç”µæœºçš„æ–¹å‘å’Œé€Ÿåº¦ï¼Œè¿˜å¯ä»¥åœæ­¢å’Œåˆ¶åŠ¨ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ TB6612FNG ç”µæœºé©±åŠ¨æ¿ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/e72dea23ce064558813e96adfb21a28a.png)
## 1.1 æ–¹å—å›¾ğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/d69cc4a675694e35b23ce349eab378d0.png)
## 1.2 å¼•è„šåŠŸèƒ½ğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/9b29060641ff44bb80c091463791f674.png)
## 1.3 ç›®æ ‡ç‰¹æ€§ğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/b721184e036a463c82d671963b4ea385.png)
## 1.4 å…¸å‹åº”ç”¨å›¾ğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/0a8cd192184b4d0ea1dd2277ef931e85.png)

# 2. æ‰€éœ€ææ–™ğŸğŸ
ä»£ç åœ°å€ï¼š[https://gitee.com/vor2345/00_Customer_Sample_Project](https://gitee.com/vor2345/00_Customer_Sample_Project "https://gitee.com/vor2345/00_Customer_Sample_Project")

è¦è·Ÿéšæœ¬æ•™ç¨‹ä¸­çš„ç”µæœºé©±åŠ¨å™¨ç¤ºä¾‹ï¼Œä»¥ä¸‹æ˜¯æ‚¨éœ€è¦çš„åŸºæœ¬ç»„ä»¶
1. ä¸€å—OneOS ä¸‡è€¦å¯ç‰©å¼€å‘æ¿ğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/cd7e078d4a71422db22ce7e50727b3fc.png)
2. è°ƒè¯•ä¸‹è½½æ¥å£ï¼šSWDè°ƒè¯•æ¥å£ã€JTAGè°ƒè¯•æ¥å£æˆ–è€…STLinkğŸğŸ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2e33ceb2ba444d789f80c612b72e924f.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/78052e98d4fd4c42962d3fbf8df1e597.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/bc9365bdef3340f29a5e722c06f2988b.png)

3.  9æ ¹æ¯æ¯çº¿ï¼Œ4æ ¹å…¬æ¯çº¿ğŸğŸğŸ

4. ä¸¤ä¸ªTTé©¬è¾¾ï¼ŒæŒ¯åŠ¨é©¬è¾¾ï¼Œ[æ¨èä¸€ä¸ªåº—é“ºï¼ˆé©¬è¾¾é›¶é…ä»¶æ¡æ¼ï¼‰ï¼š æ°ç››ç”µæœºå•†è¡Œ](https://szjs88998899.taobao.com/?spm=a1z10.1-c-s.0.0.230766574n3H6U)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/968c82ac524448a48fec6bb587f93270.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/56fc6bd8d2354a88841dd1915eca6296.png)
[ç”µåŠ›](https://learn.sparkfun.com/tutorials/electric-power)
ç”µåŠ›æ¦‚è¿°ï¼Œèƒ½é‡ä¼ è¾“ç‡ã€‚æˆ‘ä»¬å°†è®¨è®ºåŠŸç‡ã€ç“¦ç‰¹ã€æ–¹ç¨‹å¼å’Œé¢å®šåŠŸç‡çš„å®šä¹‰ã€‚1.21 å‰ç“¦çš„æ•™ç¨‹ä¹è¶£ï¼
[ææ€§](https://learn.sparkfun.com/tutorials/polarity)
ä»‹ç»ç”µå­å…ƒä»¶ä¸­çš„ææ€§ã€‚äº†è§£ä»€ä¹ˆæ˜¯ææ€§ï¼Œå“ªäº›éƒ¨åˆ†æœ‰ææ€§ï¼Œä»¥åŠå¦‚ä½•è¯†åˆ«å®ƒã€‚
[äº¤æµç”µ (AC) ä¸ç›´æµç”µ (DC)](https://learn.sparkfun.com/tutorials/alternating-current-ac-vs-direct-current-dc)
äº†è§£äº¤æµå’Œç›´æµçš„åŒºåˆ«ã€å†å²ã€äº§ç”Ÿäº¤æµå’Œç›´æµçš„ä¸åŒæ–¹å¼ä»¥åŠåº”ç”¨ç¤ºä¾‹ã€‚
[ç”µæœºå’Œé€‰æ‹©åˆé€‚çš„ç”µæœº](https://learn.sparkfun.com/tutorials/motors-and-selecting-the-right-one)
äº†è§£æ‰€æœ‰å…³äºä¸åŒç±»å‹çš„ç”µæœºåŠå…¶è¿è¡Œæ–¹å¼çš„ä¿¡æ¯ã€‚

# 3. é€‰æ‹©åˆé€‚çš„ç”µæœºé©±åŠ¨å™¨ğŸğŸğŸ
åœ¨å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆè°ˆè°ˆå¦‚ä½•æ‰¾åˆ°é€‚åˆæ‚¨éœ€æ±‚çš„ç”µæœºé©±åŠ¨å™¨ã€‚
- ç¬¬ä¸€æ­¥æ˜¯å¼„æ¸…æ¥šæ‚¨ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆç±»å‹çš„ç”µæœºå¹¶ç ”ç©¶å®ƒä»¬çš„è§„æ ¼ã€‚ä¸ºä¸å¤Ÿå¼ºå¤§çš„ç”µæœºé€‰æ‹©ç”µæœºé©±åŠ¨å™¨æ˜¯æ²¡æœ‰å¸®åŠ©çš„ã€‚æ­¤å¤–ï¼Œè¯·è®°ä½æœ‰ä¸åŒçš„ç”µæœºç±»å‹ï¼ˆæ­¥è¿›ã€ç›´æµã€æ— åˆ·ï¼‰ï¼Œå› æ­¤è¯·ç¡®ä¿æ‚¨æ­£åœ¨å¯»æ‰¾æ­£ç¡®ç±»å‹çš„ç”µæœºé©±åŠ¨å™¨ã€‚æ‚¨éœ€è¦æŒ‡å®šæ‚¨çš„ç”µæœºé©±åŠ¨å™¨å¹¶ç¡®ä¿å…¶ç”µæµå’Œç”µå‹èŒƒå›´ä¸æ‚¨çš„ç”µæœºå…¼å®¹ã€‚é¦–å…ˆï¼Œæ‚¨éœ€è¦ç¡®ä¿æ‚¨çš„ç”µæœºé©±åŠ¨å™¨èƒ½å¤Ÿå¤„ç†ç”µæœºçš„é¢å®šç”µå‹ã€‚è™½ç„¶æ‚¨é€šå¸¸å¯ä»¥è¿è¡Œç•¥é«˜äºé¢å®šå€¼çš„ç”µæœºï¼Œä½†å®ƒå¾€å¾€ä¼šç¼©çŸ­ç”µæœºçš„ä½¿ç”¨å¯¿å‘½ã€‚

- ç”µæµæ¶ˆè€—æ˜¯ç¬¬äºŒä¸ªå› ç´ ã€‚æ‚¨çš„ç”µæœºé©±åŠ¨å™¨éœ€è¦èƒ½å¤Ÿé©±åŠ¨ä¸ç”µæœºæ‹‰åŠ¨ä¸€æ ·å¤šçš„ç”µæµã€‚ä½œä¸ºä¸€èˆ¬è§„åˆ™ï¼Œç›´æ¥æŸ¥çœ‹ç”µæœºçš„åœè½¬ç”µæµç¼–å·ï¼ˆå½“æ‚¨ä¿æŒç”µæœºé™æ­¢æ—¶ç”µæµæ¶ˆè€—å­˜åœ¨ï¼‰ã€‚ç”µæœºåœ¨åœè½¬æ—¶å°†æ‹‰åŠ¨æœ€å¤§ç”µæµã€‚å³ä½¿æ‚¨ä¸æ‰“ç®—åœ¨é¡¹ç›®ä¸­åœæ­¢ç”µæœºï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå®‰å…¨çš„æ•°å­—ã€‚å¦‚æœæ‚¨çš„ç”µæœºé©±åŠ¨å™¨æ— æ³•å¤„ç†é‚£ä¹ˆå¤šç”µæµï¼Œé‚£ä¹ˆæ˜¯æ—¶å€™å¯»æ‰¾æ–°çš„ç”µæœºé©±åŠ¨å™¨ï¼ˆæˆ–ç”µæœºï¼‰äº†ã€‚æ‚¨å¯èƒ½è¿˜ä¼šæ³¨æ„åˆ°ç”µæœºé©±åŠ¨å™¨é€šå¸¸åˆ—å‡ºæœ€å¤§è¿ç»­ç”µæµå’Œæœ€å¤§å³°å€¼ç”µæµã€‚è¿™äº›è§„æ ¼å€¼å¾—æ³¨æ„ï¼Œå…·ä½“å–å†³äºæ‚¨çš„åº”ç”¨ä»¥åŠç”µæœºå°†æ‰¿å—çš„å‹åŠ›ã€‚
- æœ¬æŒ‡å—æ¶µç›–äº† TB6612FNG ç”µæœºé©±åŠ¨å™¨ï¼Œå…¶ç”µæºèŒƒå›´ä¸º2.5V è‡³ 13.5Vï¼Œèƒ½å¤Ÿæä¾›1.2A è¿ç»­ç”µæµå’Œ3.2A å³°å€¼ç”µæµï¼ˆæ¯é€šé“ï¼‰ï¼Œå› æ­¤å®ƒé€‚ç”¨äºæˆ‘ä»¬çš„å¤§å¤šæ•°ç›´æµç”µæœºã€‚å¦‚æœ TB6612FNG ä¸ç¬¦åˆæ‚¨é¡¹ç›®çš„è§„æ ¼ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„å…¶ä»–å„ç§ç”µæœºé©±åŠ¨æ¿ã€‚

ä¸ä»»ä½•ç”µè·¯æ¿ä¸€æ ·ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›äº‹æƒ…éœ€è¦è€ƒè™‘ï¼Œä¾‹å¦‚é€»è¾‘ç”µå‹ï¼ˆåŸºæœ¬ä¸Šæ˜¯å®ƒç”¨æ¥ä¸å¾®æ§åˆ¶å™¨é€šä¿¡çš„ç”µå‹ï¼‰å’Œæ•£çƒ­ã€‚è™½ç„¶è¿™äº›äº‹æƒ…è‚¯å®šéœ€è¦è€ƒè™‘ï¼Œä½†å®ƒä»¬ç›¸å¯¹å®¹æ˜“ä½¿ç”¨ç”µå¹³è½¬æ¢å™¨å’Œæ•£çƒ­å™¨ç­‰ä¸œè¥¿è¿›è¡Œä¿®å¤ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„ç”µæœºè¯•å›¾æ‹‰å‡ºçš„ç”µæµè¶…å‡ºäº†é©±åŠ¨å™¨çš„æ‰¿å—èƒ½åŠ›ï¼Œé‚£ä¹ˆæ‚¨å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚

# 4. TB6612é©±åŠ¨åŸç†ğŸğŸğŸğŸ
è®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹ TB6612FNG åˆ†æ¥å¤´çš„å¼•è„šæ’åˆ—ã€‚æˆ‘ä»¬åŸºæœ¬ä¸Šæœ‰ä¸‰ç§ç±»å‹çš„å¼•è„šï¼šç”µæºã€è¾“å…¥å’Œè¾“å‡ºï¼Œå®ƒä»¬éƒ½æ ‡åœ¨æ¿çš„èƒŒé¢ã€‚
## 4.1 å¼•è„šå®šä¹‰ğŸğŸğŸğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/559635b261b94329b845fcf896d16a9e.png)
|å¼•è„šæ ‡ç­¾|	åŠŸèƒ½|	ç”µæº/è¾“å…¥/è¾“å‡º|ç¬”è®°|
|---- |---- |---- |---- |
|VM	|ç”µæœºç”µå‹	|åŠ›é‡	|è¿™æ˜¯æ‚¨ä¸ºç”µæœºä¾›ç”µçš„åœ°æ–¹ï¼ˆ2.2V è‡³ 13.5Vï¼‰|
|VCC	|é€»è¾‘ç”µå‹	|åŠ›é‡	|è¿™æ˜¯ä¸ºèŠ¯ç‰‡ä¾›ç”µå¹¶ä¸å¾®æ§åˆ¶å™¨é€šä¿¡çš„ç”µå‹ï¼ˆ2.7V è‡³ 5.5Vï¼‰|
|GND	|åœ°é¢	|åŠ›é‡	|ç”µæœºç”µå‹å’Œé€»è¾‘ç”µå‹çš„å…¬å…±æ¥åœ°ï¼ˆæ‰€æœ‰ GND å¼•è„šå‡å·²è¿æ¥ï¼‰|
|STBY	|æ”¯æŒ	|è¾“å…¥	|å…è®¸ H æ¡¥åœ¨é«˜ç”µå¹³æ—¶å·¥ä½œï¼ˆå…·æœ‰ä¸‹æ‹‰ç”µé˜»ï¼Œå› æ­¤å¿…é¡»ä¸»åŠ¨æ‹‰é«˜ï¼‰|
|AIN1/BIN1	|é€šé“ A/B çš„è¾“å…¥ 1	|è¾“å…¥|	ç¡®å®šæ–¹å‘çš„ä¸¤ä¸ªè¾“å…¥ä¹‹ä¸€ã€‚|
|AIN2/BIN2	|é€šé“ A/B çš„è¾“å…¥ 2	|è¾“å…¥|	ç¡®å®šæ–¹å‘çš„ä¸¤ä¸ªè¾“å…¥ä¹‹ä¸€ã€‚|
|PWMA/PWMB	|é€šé“ A/B çš„ PWM è¾“å…¥	|è¾“å…¥|	æ§åˆ¶é€Ÿåº¦çš„ PWM è¾“å…¥|
|A01/B01	|é€šé“ A/B çš„è¾“å‡º 1	|è¾“å‡º	|è¿æ¥ç”µæœºçš„ä¸¤ä¸ªè¾“å‡ºä¹‹ä¸€|
|A02/B02	|é€šé“ A/B çš„è¾“å‡º 2	|è¾“å‡º|	è¿æ¥ç”µæœºçš„ä¸¤ä¸ªè¾“å‡ºä¹‹ä¸€|

## 4.2 æ§åˆ¶çŠ¶æ€è¡¨ğŸğŸğŸğŸ
ç°åœ¨ï¼Œå¿«é€Ÿäº†è§£å¦‚ä½•æ§åˆ¶æ¯ä¸ªé€šé“ã€‚å½“è¾“å‡ºè®¾ç½®ä¸ºé«˜/ä½æ—¶ï¼Œæ‚¨çš„ç”µæœºå°†è¿è¡Œã€‚å½“å®ƒä»¬è®¾ç½®ä¸ºä½/é«˜æ—¶ï¼Œç”µæœºå°†ä»¥ç›¸åçš„æ–¹å‘è¿è¡Œã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œé€Ÿåº¦éƒ½ç”± PWM è¾“å…¥æ§åˆ¶ã€‚æ§åˆ¶çŠ¶æ€è¡¨å¦‚ä¸‹

|AIN1|	AIN2|STBY	|PWMA	|A1	|æ¨¡å¼|
|---- |---- |---- |---- |---- |---- |
|H|H	|H/L|H~L|L|åœæ­¢|
|L	|H|H	|H~L|H~L	|é€†æ—¶é’ˆ|
|L|L	|H/L	|H~L|L	|åœæ­¢|
|H|L	|H|H~L	|H~L|é¡ºæ—¶é’ˆ|

> ä¸è¦å¿˜è®° STBY å¿…é¡»å¾ˆé«˜æ‰èƒ½é©±åŠ¨ç”µæœºã€‚



ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨æ‚¨é¦–é€‰çš„é¡¹ç›®å¹³å°è¿æ¥æ‰€æœ‰å†…å®¹ã€‚æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ä¸‡è€¦å¯ç‰©å¼€å‘æ¿ï¼ˆmm32)ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ä¸åŒçš„å¼•è„šæˆ–ä¸åŒçš„å¾®æ§åˆ¶å™¨ï¼Œè¯·è®°ä½ç”µæœºé©±åŠ¨å™¨çš„ PWM å¼•è„šéœ€è¦æ˜¯å¾®æ§åˆ¶å™¨ä¸Šçš„ PWM å¼•è„šã€‚
## 4.3 å¼•è„šæ¥çº¿ğŸğŸğŸğŸ
ä¸‡è€¦å¯ç‰©è¿æ¥TB6612ï¼Œç„¶åè¿æ¥å·¦å³ç”µæœºã€‚
|ç«¯å£A|ä½ç½®|ç«¯å£B|ä½ç½®|
|--- |--- |--- |--- |
|B6 |ä¸‡è€¦å¯ç‰© |PWMA |TB6612|
|B7 |ä¸‡è€¦å¯ç‰© |PWMB |TB6612 |
|A4 |ä¸‡è€¦å¯ç‰© |AIN1|TB6612|
|A5 |ä¸‡è€¦å¯ç‰© |AIN2 |TB6612 |
|A6 |ä¸‡è€¦å¯ç‰© |BIN1|TB6612 |
|A7 |ä¸‡è€¦å¯ç‰©|BIN2 |TB6612|
|GND |ä¸‡è€¦å¯ç‰© |GND|TB6612|
|3V3 |ä¸‡è€¦å¯ç‰© |STBY |TB6612 |
|5V |ä¸‡è€¦å¯ç‰© |VM|TB6612 |
|æ­£æ |å·¦ç”µæœº |AO1|TB6612|
|è´Ÿæ |å·¦ç”µæœº |AO2 |TB6612 |
|æ­£æ |å³ç”µæœº |BO1|TB6612 |
|è´Ÿæ |å³ç”µæœº|BO2 |TB6612|

å®ç‰©å›¾
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/8af893f6a84e47f6b36c640ba71a5f78.png)
# 5. ä»£ç å®ç°ğŸğŸğŸğŸğŸ
æ·»åŠ ä¸‰ä¸ªæ–‡ä»¶å°±å¯ä»¥å®ç°æ­£è½¬æ¸å˜çš„æ•ˆæœ
## 5.1 motor.cğŸğŸğŸğŸğŸ
`motor.c`PWMåˆå§‹åŒ–ï¼Œå®šä¹‰ç›¸å…³æ“ä½œå‡½æ•°

```cpp
/*********************************************************************************************************************
* COPYRIGHT NOTICE
* Copyright (c) 2019,é€é£ç§‘æŠ€
* All rights reserved.
* æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897
*
* ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
* æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
*
* @file				pwm
* @company			æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
* @author			é€é£ç§‘æŠ€(QQ3184284598)
* @version			æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
* @Software			IAR 8.3 or MDK 5.28
* @Target core		MM32F3277
* @Taobao			https://seekfree.taobao.com/
* @date				2021-02-22
********************************************************************************************************************/

#include "motor.h"
//#include "zf_gpio.h"
#include "drv_gpio.h"
#include "bsp.h"
#include "board.h"

GPIO_TypeDef *gpio_group[8] = {GPIOA, GPIOB, GPIOC, GPIOD, GPIOE, GPIOF, GPIOG, GPIOH};
extern GPIO_TypeDef *gpio_group[8];
TIM_TypeDef *tim_index[8] = {TIM1, TIM8, TIM2, TIM5, TIM3, TIM4, TIM6, TIM7};
extern TIM_TypeDef *tim_index[8];
extern uint32_t SystemCoreClock;
uint32 pwm_enable_state[8];


//-------------------------------------------------------------------------------------------------------------------
// @brief		GPIOåˆå§‹åŒ–
// @param		pin			é€‰æ‹©çš„å¼•è„š (å¯é€‰æ‹©èŒƒå›´ç”± common.h å†…PIN_enumæšä¸¾å€¼ç¡®å®š)
// @param		dir			å¼•è„šçš„æ–¹å‘
// @param		af			å¼•è„šçš„åŠŸèƒ½é€‰æ‹©
// @param		mode		å¼•è„šçš„æ¨¡å¼
// @return		void
// Sample usage:			afio_init(D5, GPO, GPIO_AF0, GPO_AF_PUSH_PUL);
//-------------------------------------------------------------------------------------------------------------------
void afio_init (PIN_enum pin, GPIODIR_enum dir, GPIOAF_enum af, GPIOMODE_enum mode)
{
	uint32 temp;
	uint8 io_group = ((pin&0xf0)>>4);															// æå–IOåˆ†ç»„
	uint8 io_pin = (pin&0x0f);																	// æå–IOå¼•è„šä¸‹æ ‡

	RCC->AHBENR |= RCC_AHBENR_GPIOA << io_group;												// ä½¿èƒ½ GPIOx æ—¶é’Ÿ

	if(io_pin < 0x08)																			// ä½8ä½å¼•è„š
	{
		temp = gpio_group[io_group]->AFRL;
		temp &= ~(0x0000000f << (io_pin*4));
		temp |= ((uint32)af << (io_pin*4));
		gpio_group[io_group]->AFRL = temp;

		temp = gpio_group[io_group]->CRL;
		temp &= ~(0x0000000f << (io_pin*4));
		temp |= (((uint32)dir|(uint32)mode) << (io_pin*4));
		gpio_group[io_group]->CRL = temp;
	}
	else																						// é«˜8ä½å¼•è„š
	{
		temp = gpio_group[io_group]->AFRH;
		temp &= ~(0x0000000f << ((io_pin-8)*4));
		temp |= ((uint32)af << ((io_pin-8)*4));
		gpio_group[io_group]->AFRH = temp;

		temp = gpio_group[io_group]->CRH;
		temp &= ~(0x0000000f << ((io_pin-8)*4));
		temp |= (((uint32)dir|(uint32)mode) << ((io_pin-8)*4));
		gpio_group[io_group]->CRH = temp;
	}
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		PWM å¼•è„šåˆå§‹åŒ– å†…éƒ¨è°ƒç”¨
// @param		pin				é€‰æ‹© PWM å¼•è„š
// @return		void			NULL
// Sample usage:				pwm_pin_init(pin);
//-------------------------------------------------------------------------------------------------------------------
static void pwm_pin_init (TIM_PWMPIN_enum pin)
{
	afio_init((PIN_enum)(pin &0xff), GPO, (GPIOAF_enum)((pin &0xf00)>>8), GPO_AF_PUSH_PUL);		// æå–å¯¹åº”IOç´¢å¼• AFåŠŸèƒ½ç¼–ç 
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		PWM åˆå§‹åŒ–
// @param		tim				é€‰æ‹© PWM ä½¿ç”¨çš„ TIM
// @param		pin				é€‰æ‹© PWM å¼•è„š
// @param		freq			è®¾ç½®é¢‘ç‡ åŒä¸ªæ¨¡å—åªæœ‰æœ€åä¸€æ¬¡è®¾ç½®ç”Ÿæ•ˆ
// @param		duty			è®¾ç½®å ç©ºæ¯”
// @return		void
// Sample usage:						pwm_init(TIM_1, TIM_1_CH1_A08, 10000, 50000/100*ch1);
//-------------------------------------------------------------------------------------------------------------------
void pwm_init (TIM_enum tim, TIM_PWMPIN_enum pin, uint32 freq, uint32 duty)
{
	if(duty > PWM_DUTY_MAX)	return;																// å ç©ºæ¯”å†™å…¥é”™è¯¯
	uint16 freq_div = ((SystemCoreClock / freq) >> 15);											// è®¡ç®—é¢„åˆ†é¢‘
	uint16 period_temp = (SystemCoreClock / freq / (freq_div+1));								// è®¡ç®—è‡ªåŠ¨é‡è£…è½½å€¼
	uint16 match_temp = (uint16)(period_temp*((float)duty/PWM_DUTY_MAX));						// è®¡ç®—å ç©ºæ¯”

	pwm_pin_init(pin);																			// åˆå§‹åŒ–å¼•è„š
	if(tim & 0xf000)
		RCC->APB2ENR |= ((uint32_t)0x00000001 << ((tim&0x0ff0) >> 4));							// ä½¿èƒ½æ—¶é’Ÿ
	else
		RCC->APB1ENR |= ((uint32_t)0x00000001 << ((tim&0x0ff0) >> 4));							// ä½¿èƒ½æ—¶é’Ÿ

	tim_index[(tim&0x0f)]->ARR = period_temp;													// è£…è½½è‡ªåŠ¨é‡è£…è½½å€¼
	tim_index[(tim&0x0f)]->PSC = freq_div;														// è£…è½½é¢„åˆ†é¢‘
	tim_index[(tim&0x0f)]->CR1 = TIM_CR1_ARPEN;													// å…è®¸è‡ªåŠ¨é‡è£…è½½å€¼çš„é¢„è£…è½½
	tim_index[(tim&0x0f)]->BDTR = TIM_BDTR_MOEN;												// PWM è¾“å‡ºä½¿èƒ½

	switch(pin&0xf000)
	{
		case 0x1000:
			tim_index[(tim&0x0f)]->CCMR1 |=														// OC1M [6:4] 110
					TIM_CCMR1_IC1F_1 | TIM_CCMR1_IC1F_2;										// PWM æ¨¡å¼ 1
			tim_index[(tim&0x0f)]->CCMR1 |= TIM_CCMR1_OC1PEN;									// å…è®¸è¾“å‡ºæ¯”è¾ƒå€¼çš„é¢„è£…è½½
			tim_index[(tim&0x0f)]->CCER |= TIM_CCER_CC1EN;										// ä½¿èƒ½é€šé“ 1
			tim_index[(tim&0x0f)]->CCR1 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
		case 0x2000:
			tim_index[(tim&0x0f)]->CCMR1 |=														// OC1M [6:4] 110
					TIM_CCMR1_IC2F_1 | TIM_CCMR1_IC2F_2;										// PWM æ¨¡å¼ 1
			tim_index[(tim&0x0f)]->CCMR1 |= TIM_CCMR1_OC2PEN;									// å…è®¸è¾“å‡ºæ¯”è¾ƒå€¼çš„é¢„è£…è½½
			tim_index[(tim&0x0f)]->CCER |= TIM_CCER_CC2EN;										// ä½¿èƒ½é€šé“ 2
			tim_index[(tim&0x0f)]->CCR2 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
		case 0x3000:
			tim_index[(tim&0x0f)]->CCMR2 |=														// OC1M [6:4] 110
					TIM_CCMR2_IC3F_1 | TIM_CCMR2_IC3F_2;										// PWM æ¨¡å¼ 1
			tim_index[(tim&0x0f)]->CCMR2 |= TIM_CCMR2_OC3PEN;									// å…è®¸è¾“å‡ºæ¯”è¾ƒå€¼çš„é¢„è£…è½½
			tim_index[(tim&0x0f)]->CCER |= TIM_CCER_CC3EN;										// ä½¿èƒ½é€šé“ 2
			tim_index[(tim&0x0f)]->CCR3 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
		case 0x4000:
			tim_index[(tim&0x0f)]->CCMR2 |=														// OC1M [6:4] 110
					TIM_CCMR2_IC4F_1 | TIM_CCMR2_IC4F_2;										// PWM æ¨¡å¼ 0
			tim_index[(tim&0x0f)]->CCMR2 |= TIM_CCMR2_OC4PEN;									// å…è®¸è¾“å‡ºæ¯”è¾ƒå€¼çš„é¢„è£…è½½
			tim_index[(tim&0x0f)]->CCER |= TIM_CCER_CC4EN;										// ä½¿èƒ½é€šé“ 2
			tim_index[(tim&0x0f)]->CCR4 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
	}
	pwm_enable_state[(tim&0x0f)] = tim_index[(tim&0x0f)]->CCER;

	tim_index[(tim&0x0f)]->CR1 |= TIM_CR1_CEN;													// ä½¿èƒ½å®šæ—¶å™¨
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		PWM ä½¿èƒ½
// @param		tim				é€‰æ‹© PWM ä½¿ç”¨çš„ TIM
// @return		void
// Sample usage:				pwm_enable(TIM_1);
//-------------------------------------------------------------------------------------------------------------------
void pwm_enable (TIM_enum tim)
{
	tim_index[(tim&0x0f)]->CCER = pwm_enable_state[(tim&0x0f)];
	tim_index[(tim&0x0f)]->CR1 |= TIM_CR1_CEN;													// ä½¿èƒ½å®šæ—¶å™¨
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		PWM å¤±èƒ½
// @param		tim				é€‰æ‹© PWM ä½¿ç”¨çš„ TIM
// @return		void
// Sample usage:				pwm_disable(TIM_1);
//-------------------------------------------------------------------------------------------------------------------
void pwm_disable (TIM_enum tim)
{
	pwm_enable_state[(tim&0x0f)] = tim_index[(tim&0x0f)]->CCER;
	tim_index[(tim&0x0f)]->CCER = 0x00000000;
	tim_index[(tim&0x0f)]->CR1 &= ~TIM_CR1_CEN;													// å¤±èƒ½å®šæ—¶å™¨
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		PWM æ›´æ–°å ç©ºæ¯”
// @param		tim				é€‰æ‹© PWM ä½¿ç”¨çš„ TIM
// @param		pin				é€‰æ‹© PWM å¼•è„š
// @param		duty			è®¾ç½®å ç©ºæ¯”
// @return		void
// Sample usage:				pwm_duty_updata(TIM_1, TIM_1_CH1_A08, 500*duty);
//-------------------------------------------------------------------------------------------------------------------
void pwm_duty_updata (TIM_enum tim, TIM_PWMPIN_enum pin, uint32 duty)
{
	if(duty > PWM_DUTY_MAX)	return;																// å ç©ºæ¯”å†™å…¥é”™è¯¯
	uint16 period_temp = tim_index[(tim&0x0f)]->ARR;											// è·å–è‡ªåŠ¨é‡è£…è½½å€¼
	uint16 match_temp = (uint16)(period_temp*((float)duty/PWM_DUTY_MAX));						// è®¡ç®—å ç©ºæ¯”

	switch(pin&0xf000)																			// æå–é€šé“å€¼
	{
		case 0x1000:
			tim_index[(tim&0x0f)]->CCR1 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
		case 0x2000:
			tim_index[(tim&0x0f)]->CCR2 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
		case 0x3000:
			tim_index[(tim&0x0f)]->CCR3 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
		case 0x4000:
			tim_index[(tim&0x0f)]->CCR4 = match_temp;											// è£…è½½æ¯”è¾ƒå€¼
			break;
	}
}


```
## 5.2 motor.hğŸğŸğŸğŸğŸ
`motor.h`ï¼Œå®šä¹‰ç›¸å…³PWMã€TIMERã€GPIOç«¯å£ï¼Œé…ç½®PWMè¾“å‡º

```cpp
/*********************************************************************************************************************
* COPYRIGHT NOTICE
* Copyright (c) 2019,é€é£ç§‘æŠ€
* All rights reserved.
* æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897
*
* ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
* æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
*
* @file				pwm
* @company			æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
* @author			é€é£ç§‘æŠ€(QQ3184284598)
* @version			æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
* @Software			IAR 8.3 or MDK 5.28
* @Target core		MM32F3277
* @Taobao			https://seekfree.taobao.com/
* @date				2021-02-22
********************************************************************************************************************/

#ifndef _motor_h
#define _motor_h

//#include "common.h"
//#include "hal_tim.h"
#include <board.h>
#include "timer.h"
#include "drv_common.h"
#include <os_task.h>
#include <device.h>
#include <string.h>
#include <arch_interrupt.h>
#include <os_task.h>
#include <device.h>
#include <os_memory.h>
#include <os_util.h>
#include <os_assert.h>
#include <drv_cfg.h>


#define DBG_TAG "motor"

#define PWM_DUTY_MAX		50000

//æ•°æ®ç±»å‹å£°æ˜
typedef unsigned char		uint8;													//  8 bits 
typedef unsigned short int	uint16;													// 16 bits 
typedef unsigned long int	uint32;													// 32 bits 
typedef unsigned long long	uint64;													// 64 bits 

typedef char				int8;													//  8 bits 
typedef short int			int16;													// 16 bits 
typedef long  int			int32;													// 32 bits 
typedef long  long			int64;													// 64 bits 

typedef volatile int8		vint8;													//  8 bits 
typedef volatile int16		vint16;													// 16 bits 
typedef volatile int32		vint32;													// 32 bits 
typedef volatile int64		vint64;													// 64 bits 

typedef volatile uint8		vuint8;													//  8 bits 
typedef volatile uint16		vuint16;												// 16 bits 
typedef volatile uint32		vuint32;												// 32 bits 
typedef volatile uint64		vuint64;												// 64 bits 



typedef enum //æšä¸¾ç«¯å£æ–¹å‘
{
	A0 = 0x00,	A1 = 0x01,	A2 = 0x02,	A3 = 0x03,	A4 = 0x04,	A5 = 0x05,	A6 = 0x06,	A7 = 0x07,
	A8 = 0x08,	A9 = 0x09,	A10 = 0x0A,	A11 = 0x0B,	A12 = 0x0C,	A13 = 0x0D,	A14 = 0x0E,	A15 = 0x0F,

	B0 = 0x10,	B1 = 0x11,	B2 = 0x12,	B3 = 0x13,	B4 = 0x14,	B5 = 0x15,	B6 = 0x16,	B7 = 0x17,
	B8 = 0x18,	B9 = 0x19,	B10 = 0x1A,	B11 = 0x1B,	B12 = 0x1C,	B13 = 0x1D,	B14 = 0x1E,	B15 = 0x1F,

	C0 = 0x20,	C1 = 0x21,	C2 = 0x22,	C3 = 0x23,	C4 = 0x24,	C5 = 0x25,	C6 = 0x26,	C7 = 0x27,
	C8 = 0x28,	C9 = 0x29,	C10 = 0x2A,	C11 = 0x2B,	C12 = 0x2C,	C13 = 0x2D,	C14 = 0x2E,	C15 = 0x2F,

	D0 = 0x30,	D1 = 0x31,	D2 = 0x32,	D3 = 0x33,	D4 = 0x34,	D5 = 0x35,	D6 = 0x36,	D7 = 0x37,
	D8 = 0x38,	D9 = 0x39,	D10 = 0x3A,	D11 = 0x3B,	D12 = 0x3C,	D13 = 0x3D,	D14 = 0x3E,	D15 = 0x3F,

	E0 = 0x40,	E1 = 0x41,	E2 = 0x42,	E3 = 0x43,	E4 = 0x44,	E5 = 0x45,	E6 = 0x46,	E7 = 0x47,
	E8 = 0x48,	E9 = 0x49,	E10 = 0x4A,	E11 = 0x4B,	E12 = 0x4C,	E13 = 0x4D,	E14 = 0x4E,	E15 = 0x4F,

	F0 = 0x50,	F1 = 0x51,	F2 = 0x52,	F3 = 0x53,	F4 = 0x54,	F5 = 0x55,	F6 = 0x56,	F7 = 0x57,
	F8 = 0x58,	F9 = 0x59,	F10 = 0x5A,	F11 = 0x5B,	F12 = 0x5C,	F13 = 0x5D,	F14 = 0x5E,	F15 = 0x5F,

	G0 = 0x60,	G1 = 0x61,	G2 = 0x62,	G3 = 0x63,	G4 = 0x64,	G5 = 0x65,	G6 = 0x66,	G7 = 0x67,
	G8 = 0x68,	G9 = 0x69,	G10 = 0x6A,	G11 = 0x6B,	G12 = 0x6C,	G13 = 0x6D,	G14 = 0x6E,	G15 = 0x6F,

	H0 = 0x70,	H1 = 0x71,	H2 = 0x72,	H3 = 0x73,
}PIN_enum;
typedef enum																					// æšä¸¾ç«¯å£æ–¹å‘
{
	GPI = 0x00,																					// å®šä¹‰ç®¡è„šè¾“å…¥
	GPO = 0x03,																					// å®šä¹‰ç®¡è„šè¾“å‡º
}GPIODIR_enum;

typedef enum																					// æšä¸¾ç«¯å£æ–¹å‘
{
	GPI_ANAOG_IN		= 0x00,																	// å®šä¹‰ç®¡è„šæ¨¡æ‹Ÿè¾“å…¥
	GPI_FLOATING_IN		= 0x04,																	// å®šä¹‰ç®¡è„šæµ®ç©ºè¾“å…¥
	GPI_PULL_DOWN		= 0x08,																	// å®šä¹‰ç®¡è„šä¸‹æ‹‰è¾“å…¥
	GPI_PULL_UP			= 0x08,																	// å®šä¹‰ç®¡è„šä¸Šæ‹‰è¾“å…¥

	GPO_PUSH_PULL		= 0x00,																	// å®šä¹‰ç®¡è„šæ¨æŒ½è¾“å‡º
	GPO_OPEN_DTAIN		= 0x04,																	// å®šä¹‰ç®¡è„šå¼€æ¼è¾“å‡º
	GPO_AF_PUSH_PUL		= 0x08,																	// å®šä¹‰ç®¡è„šå¤ç”¨æ¨æŒ½è¾“å‡º
	GPO_AF_OPEN_DTAIN	= 0x0C,																	// å®šä¹‰ç®¡è„šå¤ç”¨å¼€æ¼è¾“å‡º
}GPIOMODE_enum;

typedef enum																					// æšä¸¾ç«¯å£ç”µå¹³
{
	GPIO_AF0 = 0x00,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  0
	GPIO_AF1 = 0x01,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  1
	GPIO_AF2 = 0x02,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  2
	GPIO_AF3 = 0x03,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  3
	GPIO_AF4 = 0x04,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  4
	GPIO_AF5 = 0x05,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  5
	GPIO_AF6 = 0x06,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  6
	GPIO_AF7 = 0x07,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  7
	GPIO_AF8 = 0x08,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  8
	GPIO_AF9 = 0x09,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹  9
	GPIO_AF10 = 0x0A,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹ 10
	GPIO_AF11 = 0x0B,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹ 11
	GPIO_AF12 = 0x0C,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹ 12
	GPIO_AF13 = 0x0D,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹ 13
	GPIO_AF14 = 0x0E,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹ 14
	GPIO_AF15 = 0x0F,																			// å¼•è„šå¤ç”¨åŠŸèƒ½é€‰é¡¹ 15
}GPIOAF_enum;

typedef enum
{
	// Advanced Timer 16 bits
	TIM_1					= 0x1000,												// 0x1000[APB2]	0x0000[APB_EN BIT] 0x0000[TIM index]
	TIM_8					= 0x1011,												// 0x1000[APB2]	0x0010[APB_EN BIT] 0x0001[TIM index]

	// General Timer 32 bits
	TIM_2					= 0x0002,												// 0x0000[APB1]	0x0000[APB_EN BIT] 0x0002[TIM index]
	TIM_5					= 0x0033,												// 0x0000[APB1]	0x0030[APB_EN BIT] 0x0003[TIM index]

	// General Timer 16 bits
	TIM_3					= 0x0014,												// 0x0000[APB1]	0x0010[APB_EN BIT] 0x0004[TIM index]
	TIM_4					= 0x0025,												// 0x0000[APB1]	0x0020[APB_EN BIT] 0x0005[TIM index]

	// Basic Timer 16 bits
	TIM_6					= 0x0046,												// 0x0000[APB1]	0x0040[APB_EN BIT] 0x0006[TIM index]
	TIM_7					= 0x0057,												// 0x0000[APB1]	0x0050[APB_EN BIT] 0x0007[TIM index]
}TIM_enum;

typedef enum
{
	// Advanced Timer 16 bits TIM1
	TIM_1_CH1_A08			= 0x1108,												// 0x1000[CH1] 0x0100[AF1] 0x0000[A group] 0x0008[pin  8]
	TIM_1_CH1_E09			= 0x1149,												// 0x1000[CH1] 0x0100[AF1] 0x0040[E group] 0x0009[pin  9]

	TIM_1_CH2_A09			= 0x2109,												// 0x2000[CH2] 0x0100[AF1] 0x0000[A group] 0x0009[pin  9]
	TIM_1_CH2_E11			= 0x214B,												// 0x2000[CH2] 0x0100[AF1] 0x0040[E group] 0x000B[pin 11]

	TIM_1_CH3_A10			= 0x310A,												// 0x3000[CH3] 0x0100[AF1] 0x0000[A group] 0x000A[pin 10]
	TIM_1_CH3_E13			= 0x314D,												// 0x3000[CH2] 0x0100[AF1] 0x0040[E group] 0x000D[pin 13]

	TIM_1_CH4_A11			= 0x410B,												// 0x4000[CH4] 0x0100[AF1] 0x0000[A group] 0x000B[pin 11]
	TIM_1_CH4_E14			= 0x414E,												// 0x4000[CH4] 0x0100[AF1] 0x0040[E group] 0x000E[pin 14]

	// Advanced Timer 16 bits TIM8
	TIM_8_CH1_C06			= 0x1326,												// 0x1000[CH1] 0x0300[AF3] 0x0020[C group] 0x0006[pin  6]

	TIM_8_CH2_C07			= 0x2327,												// 0x2000[CH2] 0x0300[AF3] 0x0020[C group] 0x0007[pin  7]

	TIM_8_CH3_C08			= 0x3328,												// 0x3000[CH3] 0x0300[AF3] 0x0020[C group] 0x0008[pin  8]

	TIM_8_CH4_C09			= 0x4329,												// 0x4000[CH4] 0x0300[AF3] 0x0020[C group] 0x0009[pin  9]

	// General Timer 32 bits TIM2
	TIM_2_CH1_A00			= 0x1100,												// 0x1000[CH1] 0x0100[AF1] 0x0000[A group] 0x0000[pin  0]
	TIM_2_CH1_A05			= 0x1105,												// 0x1000[CH1] 0x0100[AF1] 0x0000[A group] 0x0005[pin  5]
	TIM_2_CH1_A15			= 0x110F,												// 0x1000[CH1] 0x0100[AF1] 0x0000[A group] 0x000F[pin 15]

	TIM_2_CH2_A01			= 0x2101,												// 0x2000[CH2] 0x0100[AF1] 0x0000[A group] 0x0001[pin  1]
	TIM_2_CH2_B03			= 0x2113,												// 0x2000[CH2] 0x0100[AF1] 0x0010[B group] 0x0003[pin  3]

	TIM_2_CH3_A02			= 0x3102,												// 0x3000[CH3] 0x0100[AF1] 0x0000[A group] 0x0002[pin  2]
	TIM_2_CH3_B10			= 0x311A,												// 0x3000[CH3] 0x0100[AF1] 0x0010[B group] 0x000A[pin 10]

	TIM_2_CH4_A03			= 0x4103,												// 0x4000[CH4] 0x0100[AF1] 0x0000[A group] 0x0003[pin  3]
	TIM_2_CH4_B11			= 0x411B,												// 0x4000[CH4] 0x0100[AF1] 0x0010[B group] 0x000B[pin 11]

	// General Timer 32 bits TIM5
	TIM_5_CH1_A00			= 0x1200,												// 0x1000[CH1] 0x0200[AF2] 0x0000[A group] 0x0000[pin  0]

	TIM_5_CH2_A01			= 0x2201,												// 0x2000[CH2] 0x0200[AF2] 0x0000[A group] 0x0001[pin  1]

	TIM_5_CH3_A02			= 0x3202,												// 0x3000[CH3] 0x0200[AF2] 0x0000[A group] 0x0002[pin  2]

	TIM_5_CH4_A03			= 0x4203,												// 0x4000[CH4] 0x0200[AF2] 0x0000[A group] 0x0003[pin  3]

	// General Timer 16 bits TIM3
	TIM_3_CH1_A06			= 0x1206,												// 0x1000[CH1] 0x0200[AF2] 0x0000[A group] 0x0006[pin  6]
	TIM_3_CH1_B04			= 0x1214,												// 0x1000[CH1] 0x0200[AF2] 0x0010[B group] 0x0004[pin  4]
	TIM_3_CH1_C06			= 0x1226,												// 0x1000[CH1] 0x0200[AF2] 0x0020[C group] 0x0006[pin  6]

	TIM_3_CH2_A07			= 0x2207,												// 0x2000[CH2] 0x0200[AF2] 0x0000[A group] 0x0007[pin  7]
	TIM_3_CH2_B05			= 0x2215,												// 0x2000[CH2] 0x0200[AF2] 0x0010[B group] 0x0005[pin  5]
	TIM_3_CH2_C07			= 0x2227,												// 0x2000[CH2] 0x0200[AF2] 0x0020[C group] 0x0007[pin  7]

	TIM_3_CH3_B00			= 0x3210,												// 0x3000[CH3] 0x0200[AF2] 0x0010[B group] 0x0000[pin  0]
	TIM_3_CH3_C08			= 0x3228,												// 0x3000[CH3] 0x0200[AF2] 0x0020[C group] 0x0008[pin  8]

	TIM_3_CH4_B01			= 0x4211,												// 0x4000[CH4] 0x0200[AF2] 0x0010[B group] 0x0001[pin  1]
	TIM_3_CH4_C09			= 0x4229,												// 0x4000[CH4] 0x0200[AF2] 0x0020[C group] 0x0009[pin  9]

	// General Timer 16 bits TIM4
	TIM_4_CH1_B06			= 0x1216,												// 0x1000[CH1] 0x0200[AF2] 0x0010[B group] 0x0006[pin  6]
	TIM_4_CH1_D12			= 0x123C,												// 0x1000[CH1] 0x0200[AF2] 0x0030[D group] 0x000C[pin 12]

	TIM_4_CH2_B07			= 0x2217,												// 0x2000[CH2] 0x0200[AF2] 0x0010[B group] 0x0007[pin  7]
	TIM_4_CH2_D13			= 0x223D,												// 0x2000[CH2] 0x0200[AF2] 0x0030[D group] 0x000D[pin 13]

	TIM_4_CH3_B08			= 0x3218,												// 0x3000[CH3] 0x0200[AF2] 0x0010[B group] 0x0008[pin  8]
	TIM_4_CH3_D14			= 0x323E,												// 0x3000[CH3] 0x0200[AF2] 0x0030[D group] 0x000E[pin 14]

	TIM_4_CH4_B09			= 0x4219,												// 0x4000[CH4] 0x0200[AF2] 0x0010[B group] 0x0009[pin  9]
	TIM_4_CH4_D15			= 0x423F,												// 0x4000[CH4] 0x0200[AF2] 0x0030[D group] 0x000F[pin 15]
}TIM_PWMPIN_enum;

void afio_init (PIN_enum pin, GPIODIR_enum dir, GPIOAF_enum af, GPIOMODE_enum mode);
void pwm_init (TIM_enum tim, TIM_PWMPIN_enum pin, uint32 freq, uint32 duty);
void pwm_enable (TIM_enum tim);
void pwm_disable (TIM_enum tim);
void pwm_duty_updata (TIM_enum tim, TIM_PWMPIN_enum pin, uint32 duty);

#endif

```
## 5.3 test_motor.cğŸğŸğŸğŸğŸ
 `test_motor.c` ï¼Œæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰§è¡ŒåŒç”µæœºå‰è¿›æ¸å˜ï¼å‰è¿›åé€€å‡½æ•°å¯ä»¥è‡ªå·±è°ƒè¯•ä½¿ç”¨ã€‚
 

```cpp
#include <drv_cfg.h>
#include <device.h>
#include <os_clock.h>
#include <os_memory.h>
#include <stdlib.h>
#include <shell.h>
#include <timer/clocksource.h>
#include "motor.h"
#include "drv_gpio.h"

// *************************** ä¾‹ç¨‹è¯´æ˜ ***************************
// 
// æµ‹è¯•éœ€è¦å‡†å¤‡ ä¸­å›½ç§»åŠ¨ OneOS å¯ç‰©å¼€å‘æ¿ ä¸€å—
// 
// è°ƒè¯•ä¸‹è½½éœ€è¦å‡†å¤‡é€é£ç§‘æŠ€ CMSIS-DAP è°ƒè¯•ä¸‹è½½å™¨ æˆ– ARM è°ƒè¯•ä¸‹è½½å™¨ ä¸€ä¸ª
// 
// æœ¬ä¾‹ç¨‹æ¼”ç¤ºæ‹“å±•æ¥å£ä¸Š B6-B7 å¼•è„šçš„ PWM åŠŸèƒ½ï¼ŒA4-A7åˆ†åˆ«è´Ÿè´£å·¦å³ä¸¤è·¯æ–¹å‘
// 
// æ‰“å¼€æ–°çš„å·¥ç¨‹æˆ–è€…å·¥ç¨‹ç§»åŠ¨äº†ä½ç½®åŠ¡å¿…æ‰§è¡Œä»¥ä¸‹æ“ä½œ
// ç¬¬ä¸€æ­¥ å…³é—­ä¸Šé¢æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶
// ç¬¬äºŒæ­¥ project->clean  ç­‰å¾…ä¸‹æ–¹è¿›åº¦æ¡èµ°å®Œ
// 
// *************************** ä¾‹ç¨‹è¯´æ˜ ***************************

// **************************** å®å®šä¹‰ ****************************
#define EXPAND_PWM_TIM			TIM_4
#define EXPAND_PWM_FRQE			16000
#define EXPAND_PWM_CH1			TIM_4_CH1_B06
#define EXPAND_PWM_CH2			TIM_4_CH2_B07

// **************************** å®å®šä¹‰ ****************************

// **************************** å˜é‡å®šä¹‰ ****************************
int pwm_duty = 0;

bool pwm_dir = true;
// **************************** å˜é‡å®šä¹‰ ****************************

// **************************** ä»£ç åŒºåŸŸ ****************************
int pwm_motor(void)
{
//	board_init(true);																// åˆå§‹åŒ– debug è¾“å‡ºä¸²å£
	void turn_forward(int rb,int lb);
	//æ­¤å¤„ç¼–å†™ç”¨æˆ·ä»£ç (ä¾‹å¦‚ï¼šå¤–è®¾åˆå§‹åŒ–ä»£ç ç­‰)
	pwm_init(EXPAND_PWM_TIM, EXPAND_PWM_CH1, EXPAND_PWM_FRQE, 0);
	pwm_init(EXPAND_PWM_TIM, EXPAND_PWM_CH2, EXPAND_PWM_FRQE, 0);

	os_pin_mode(A4, PIN_MODE_OUTPUT);
	os_pin_mode(A5, PIN_MODE_OUTPUT);
	os_pin_mode(A6, PIN_MODE_OUTPUT);
	os_pin_mode(A7, PIN_MODE_OUTPUT);
	os_kprintf("\r\nMM32 OneOS EVBoard MISC.");
	os_kprintf("\r\nExample 23_Expand_PWM_Demo.");
	//æ­¤å¤„ç¼–å†™ç”¨æˆ·ä»£ç (ä¾‹å¦‚ï¼šå¤–è®¾åˆå§‹åŒ–ä»£ç ç­‰)

	while(1)
	{
		//æ­¤å¤„ç¼–å†™éœ€è¦å¾ªç¯æ‰§è¡Œçš„ä»£ç 
		if(pwm_dir)
			pwm_duty += 50;
		else
			pwm_duty -= 50;

		if(pwm_duty >= PWM_DUTY_MAX)
		{
			pwm_duty = PWM_DUTY_MAX;
			pwm_dir = false;
		}
		if(pwm_duty <= 0)
		{
			pwm_duty = 0;
			pwm_dir = true;
		}
		os_kprintf("pwm_duty: %d; %d \r\n",pwm_duty,pwm_duty/(PWM_DUTY_MAX/100));
		turn_forward(pwm_duty,PWM_DUTY_MAX-pwm_duty);//è°ƒç”¨å‰è¿›ç¨‹åºï¼ˆæ­¤å¤„æ•…æ„ç›¸å‡ï¼‰


		os_task_msleep(10);
		//æ­¤å¤„ç¼–å†™éœ€è¦å¾ªç¯æ‰§è¡Œçš„ä»£ç 
	}
}

// *************************** turn_forwardå‡½æ•°è¯´æ˜ ***************************
// åŠŸèƒ½ï¼šå‰è¿›å·¦å³è½¬ä½¿èƒ½å·¦å³è½®
// å‚æ•°1ï¼šrbå ç©ºæ¯”
// å‚æ•°2ï¼šlbå ç©ºæ¯”
// å‰è¿›å·¦å³åˆ†åˆ«ä½¿èƒ½
// 
// *************************** forward ***************************
void turn_forward(int rb,int lb){
	os_pin_write(A4, 0);
	os_pin_write(A5, 1);
	os_pin_write(A6, 0);
	os_pin_write(A7, 1);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH1, rb);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH2, lb);
}

// *************************** forwardå‡½æ•°è¯´æ˜ ***************************
// åŠŸèƒ½ï¼šå‰è¿›ä½¿èƒ½å·¦å³è½®
// å‚æ•°1ï¼šrllå ç©ºæ¯”
// å·¦å³ä½¿èƒ½rll
// 
// *************************** forward ***************************
void forward(int rlf){
	os_pin_write(A4, 0);
	os_pin_write(A5, 1);
	os_pin_write(A6, 0);
	os_pin_write(A7, 1);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH1, rlf);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH2, rlf);
}

// *************************** turn_backwardå‡½æ•°è¯´æ˜ ***************************
// åŠŸèƒ½ï¼šåé€€å·¦å³è½¬ä½¿èƒ½å·¦å³è½®
// å‚æ•°1ï¼šrbå ç©ºæ¯”
// å‚æ•°2ï¼šlbå ç©ºæ¯”
// åé€€å·¦å³åˆ†åˆ«ä½¿èƒ½
// 
// *************************** backward ***************************
void turn_backward(int rb,int lb){
	os_pin_write(A4, 1);
	os_pin_write(A5, 0);
	os_pin_write(A6, 1);
	os_pin_write(A7, 0);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH1, rb);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH2, lb);
}

// *************************** backwardå‡½æ•°è¯´æ˜ ***************************
// åŠŸèƒ½ï¼šåé€€ä½¿èƒ½å·¦å³è½®
// å‚æ•°1ï¼šrlbå ç©ºæ¯”
// å·¦å³ä½¿èƒ½rlb
// 
// *************************** backward ***************************
void backward(int rlb){
	os_pin_write(A4, 1);
	os_pin_write(A5, 0);
	os_pin_write(A6, 1);
	os_pin_write(A7, 0);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH1, rlb);
	pwm_duty_updata(EXPAND_PWM_TIM, EXPAND_PWM_CH2, rlb);
}


// **************************** ä»£ç åŒºåŸŸ ****************************
SH_CMD_EXPORT(pwm_motor, pwm_motor, "two pwm motor sample!");


```

æˆ‘æ˜¯åŸºäº[ã€ä¾‹ç¨‹ã€‘OneOSå¯ç‰©å¼€å‘æ¿æ¿çº§æ”¯æŒåŒ…(BSP)(oo_Customer_Sample_Project)](https://download.csdn.net/download/VOR234/86504837)ä»£ç ç»§ç»­ç¼–å†™çš„ï¼Œ
æ·»åŠ è¿‡ç¨‹å¦‚ä¸‹
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/c4f227d8adab4aa896bef4e15bfecc64.png)

ä¸‰ä¸ªæ–‡ä»¶æ·»åŠ åæ•ˆæœå¦‚ä¸‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/792ec80808e44f49b1b6c627d9e4a5ca.png)
ä¿®æ”¹`main.c`ï¼Œæ³¨é‡Šæ‰“å°æ—¶é—´

```cpp
/**
 ***********************************************************************************************************************
 * Copyright (c) 2020, China Mobile Communications Group Co.,Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with 
 * the License. You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * @file        main.c
 *
 * @brief       User application entry
 *
 * @revision
 * Date         Author          Notes
 * 2020-02-20   OneOS Team      First Version
 ***********************************************************************************************************************
 */

#include <board.h>
#include <timer/clocksource.h>

// *************************** ä¾‹ç¨‹è¯´æ˜ ***************************
// 
// æµ‹è¯•éœ€è¦å‡†å¤‡ <OneOS å¯ç‰©å¼€å‘æ¿> ä¸€å—
// æ¨è MDK ç‰ˆæœ¬ä¸º MDK5.28a
// 
// è°ƒè¯•ä¸‹è½½éœ€è¦å‡†å¤‡ <é€é£ç§‘æŠ€ CMSIS-DAP è°ƒè¯•ä¸‹è½½å™¨> æˆ– <ARM è°ƒè¯•ä¸‹è½½å™¨> ä¸€ä¸ª
// æˆ–è€…ä½¿ç”¨ <æ ‡å‡† Jlink> è¿›è¡Œä¸‹è½½è°ƒè¯•è¿æ¥äº¦å¯
// 
// ç¡®è®¤è¿æ¥æ— è¯¯ ä¸Šç”µ å¯ä½¿ç”¨è°ƒè¯•ä¸‹è½½å™¨ä¾›ç”µ ä½†æ¨èä½¿ç”¨ USBä¾›ç”µ å¯é€šè¿‡CH340çš„Type-Cè¿›è¡Œä¾›ç”µ
// çƒ§å½•æœ¬ä¾‹ç¨‹å å¦‚æœä½¿ç”¨çš„æ˜¯ <é€é£ç§‘æŠ€ CMSIS-DAP è°ƒè¯•ä¸‹è½½å™¨> æˆ– <ARM è°ƒè¯•ä¸‹è½½å™¨>
// å¯ä»¥ç›´æ¥åœ¨ä¸²å£åŠ©æ‰‹ä¸­æ‰“å¼€å¯¹åº”ä¸²å£
// å¦‚æœä½¿ç”¨çš„å¹¶ä¸æ˜¯ <é€é£ç§‘æŠ€ CMSIS-DAP è°ƒè¯•ä¸‹è½½å™¨> æˆ– <ARM è°ƒè¯•ä¸‹è½½å™¨>
// è¯·æ¥ä¸Š CH340 æ ‡è¯†çš„Type-Cæ¥å£åˆ°ç”µè„‘USB å†æ‰“å¼€ä¸²å£è°ƒè¯•åŠ©æ‰‹æ‰“å¼€å¯¹åº”ä¸²å£
// 
// æœ¬å·¥ç¨‹ä¸ºç”¨æˆ·ç¤ºä¾‹å·¥ç¨‹ ä»…å¼€å¯åŸºç¡€åŠŸèƒ½
// 
// æ‰“å¼€æ–°çš„å·¥ç¨‹æˆ–è€…å·¥ç¨‹ç§»åŠ¨äº†ä½ç½®åŠ¡å¿…æ‰§è¡Œä»¥ä¸‹æ“ä½œ
// ç¬¬ä¸€æ­¥ å…³é—­ä¸Šé¢æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶
// ç¬¬äºŒæ­¥ project->clean  ç­‰å¾…ä¸‹æ–¹è¿›åº¦æ¡èµ°å®Œ
// 
// 2021-08-12	SEEKFREE
// 
// *************************** ä¾‹ç¨‹è¯´æ˜ ***************************

static void user_task(void *parameter)
{
	os_int32_t time_count = 1;

	os_task_msleep(1000);
	os_kprintf("\r\nWhat's up?\r\n");
    while (1)
    {
//		os_kprintf("%dh %dm %ds was wasted.\r\n", time_count/3600, time_count/60%60, time_count%60);
		time_count++;
		os_task_msleep(1000);
    }
}

int main(void)
{
    os_task_t *task;

    task = os_task_create("user", user_task, NULL, 1024, 3);
    OS_ASSERT(task);
    os_task_startup(task);

    return 0;
}

```
# 6. è°ƒè¯•éªŒè¯ğŸğŸğŸğŸğŸğŸ
## 6.1 ç¼–è¯‘ä¸Šä¼ ğŸğŸğŸğŸğŸğŸ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/ee4b8be77485494a84ea87e9689fda3c.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/319cc9d4e85e43d3a2b54e4a212b7a43.png)
## 6.2 å®ç‰©æ•ˆæœğŸğŸğŸğŸğŸğŸ
æ‰“å¼€ä¸²å£ï¼Œè¾“å…¥`pwm_motor`æŒ‡ä»¤ï¼Œ
å°é©¬è¾¾ç–¯ç‹‚æŠ–åŠ¨ğŸ¤£ğŸ¤£ğŸ¤£
![è¯·æ·»åŠ å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/d7958b9c178d4502966e44a56bf71e95.gif)
# 7. æ€»ç»“ğŸ‘»ğŸ‘»ğŸ‘»
æœ‰ç‚¹å°é—æ†¾ï¼Œæ²¡æœ‰configå¥½åŠ å…¥cubeé…ç½®ğŸ˜…ï¼Œä½†ä¸€åˆ‡èµ°æ¥éƒ½æ˜¯å€¼å¾—çš„ã€‚éå¸¸æ„Ÿè°¢OneOSæ‚¨ä»¬ç»„ç»‡è¿™æ¬¡æ´»åŠ¨ï¼Œåœ¨è¿™é‡Œé¢æˆ‘å­¦ä¹ åˆ°å¾ˆå¤šå•ç‰‡æœºå®æ—¶æ“ä½œç³»ç»Ÿå¼€å‘çš„çŸ¥è¯†ï¼ŒæœŸå¾…ä¸‹ä¸€æ¬¡å‚åŠ ä½ ä»¬çš„æ´»åŠ¨ï¼ğŸ¤£ğŸ¤£ğŸ¤£

å‚è€ƒæ–‡çŒ®ï¼š
- [TB6612FNG è¿æ¥æŒ‡å—](https://learn.sparkfun.com/tutorials/tb6612fng-hookup-guide/all)
- 	[TB6612FNG æ•°æ®è¡¨/ä¸­æ–‡ï¼ˆç¿»è¯‘ç‰ˆï¼‰](https://toshiba-semicon-storage.com/info/docget.jsp?did=30692&prodName=TB6612FNG)
